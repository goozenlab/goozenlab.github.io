<!DOCTYPE html>
<html lang="en">
<head>

  
  <meta charset="utf-8">
  <title>Unisonの設定 | goozenlab</title>
  <meta name="description" content="">
  <meta name="author" content="jin">
  
<meta name="viewport" content="width=device-width, initial-scale=1">







<link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">


  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css">

<link rel="stylesheet" href="https://goozenlab.com/css/custom.css">


<link rel="shortcut icon" href="https://goozenlab.com//img/favicon.ico" type="image/x-icon">



<script async src="https://www.googletagmanager.com/gtag/js?id=UA-125185379-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125185379-1');
</script>

  

<link rel="stylesheet" href="https://goozenlab.com/highlight/styles/atom-one-dark.css">

<script src="https://goozenlab.com/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-4562670868665621",
          enable_page_level_ads: true
     });
</script>



 
</head>
<body>

<div class="header pure-g">
    <div class="pure-u-1-24 pure-u-md-2-24"></div>
    <div class="pure-u-11-12 pure-u-md-21-24">
        <div class="desktop pure-menu pure-menu-horizontal nav-menu">
            
            <a href="https://goozenlab.com/" class="site-title pure-menu-heading">goozenlab</a>
            <ul class="pure-menu-list pull-right">
				
                <li class="pure-menu-item">
                    <a href="https://goozenlab.com/tags/update/" class="pure-menu-link">update</a>
                </li>
                
                <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
					<a href="#" id="menuLink1" class="pure-menu-link">iapps</a>
					<ul class="pure-menu-children">
						<li class="pure-menu-item"><a href="https://goozenlab.com/iapp/littlist/" class="pure-menu-link">littlist</a></li>
						<li class="pure-menu-item"><a href="https://goozenlab.com/iapp/sati/" class="pure-menu-link">sati</a></li>
                		<li class="pure-menu-item"><a href="https://goozenlab.com/iapp/dandori/" class="pure-menu-link">dandori</a></li>
                		<li class="pure-menu-item"><a href="https://goozenlab.com/iapp/ohayo/" class="pure-menu-link">ohayo</a></li>
                		<li class="pure-menu-item"><a href="https://goozenlab.com/iapp/cosper/" class="pure-menu-link">cosper</a></li>
                		<li class="pure-menu-item"><a href="https://goozenlab.com/iapp/doop/" class="pure-menu-link">doop</a></li>
                		<li class="pure-menu-item"><a href="https://goozenlab.com/iapp/tapas/" class="pure-menu-link">tapas</a></li>
            		</ul>
        		</li>
                <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
					<a href="#" id="menuLink1" class="pure-menu-link">project</a>
					<ul class="pure-menu-children">
						<li class="pure-menu-item pure-menu-link">travel router</li>
						<li class="pure-menu-item pure-menu-link">home pi server</li>
						<li class="pure-menu-item pure-menu-link">triple boot thinkpad t480s</li>
						
					</ul>
					
				</li>
                <li class="pure-menu-item">
                    <a href="https://goozenlab.com/about/" class="pure-menu-link">about</a>
                </li>
            </ul>
        </div>
        <div class="mobile pure-menu nav-menu">
            <a href="/" class="pure-menu-heading" id="toggle-home">goozenlab</a>
            <a href="#" id="toggle-btn">&#9776;</a>
            <ul class="pure-menu-list" id="toggle-content" style="display:none;">
                
				
                <li class="pure-menu-item">
                    <a href="https://goozenlab.com/categories/develop/" class="pure-menu-link">dev</a>
                </li>
                <li class="pure-menu-item">
                    <a href="https://goozenlab.com/categories/update/" class="pure-menu-link">update</a>
                </li>
                <li class="pure-menu-item">
                    <a href="https://goozenlab.com/categories/goods/" class="pure-menu-link">goods</a>
                </li>
                <li class="pure-menu-item">
                    <a href="https://goozenlab.com/categories/nomad/" class="pure-menu-link">nomad</a>
                </li>
                <li class="pure-menu-item">
                    <a href="https://goozenlab.com/about/" class="pure-menu-link">about</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="pure-u-1-24 pure-u-md-1-24"></div>
</div>


<div class="pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
	<div class="pure-u-11-12 pure-u-md-14-24">
        <div class="post">
            <div class="post-title">
                <p class="footnote">
                    <time class="">2019-08-21</time>
		            
                    
                    |
                    
                    
                    tags:<a href="https://goozenlab.com/tags/sync">sync</a> 
                    

                    
                    categories:<a href="https://goozenlab.com/categories/server">server</a> 
                    

                    
                </p>
                <h1>Unisonの設定</h1>
            </div>

            <div class="post-content">
                

<p>滞在先、タイ・チェンライで折りたたみ自転車のタイヤチューブ交換をしました。工賃込みで150バーツでした。
チューブの質がどうだかわかりませんが、安い、ありがたい、ありがとー。</p>

<p>ついでに、ボロボロになった水中眼鏡（度つき）もリフレッシュ、
ダイソーで買ったゴーグルから目にあたる部分を取り替えて完成。
ちなみにバンド部分は中古の子供ゴーグル５バーツから流用。
まぁ、頓珍漢な感じですが、別につけて外を歩くわけではないので、オケ。</p>

<p><img src="/images/2019-081-9-gogle.jpg" alt="水中眼鏡" /></p>

<p>さて、運用中にのパイ・サーバーとマックブックとの同期を図るため、unisonを設定します。
設定ファイルを作って<code>unison 設定ファイル名</code>で実行することができます。</p>

<h2 id="同期設定">同期設定</h2>

<p>シンプルな設定ファイルです。新しいファイルを優先して、接続先の設定をします。
ssh経由の接続ですので鍵でのログイン方式に切り替えると良いと思います。</p>

<p>こちら、<a href="https://goozenlab.com/blog/2019/06/rsa-ssh-login/">SSH簡単ログイン</a>
を参照のほど。</p>

<p>設定ファイルは<code>vi ~/.unison/tacos_scripts.prf</code>で作成、内容は以下。</p>

<pre><code># tacos_scripts.prf
# パイ・サーバーとマックブックのスクリプト同期
times = true
prefer = newer

auto = true
fastcheck = true

# 動作確認が取れたらコメントを外してよし。
#silent = true

# ルート・ディレクトリの指定。同期時に最上位となるディレクトリを設定する。
root = /Volumes/Work/Development/Scripts
root = ssh://tacos//home/pi/script

# sshのオプション： ssh -l pi XXXXX
# sshへの接続は鍵を使った方法に切り替え済み
sshargs=-l pi

# 同期したいディレクトリやファイル名を指定する
# 空白は全て
path =

# 除外ファイルリスト
include ignore_filelist_macos
</code></pre>

<div class="attention">※ 注意：unisonのデフォルト設定ではシンボリックリンクを同期しません。</div>

<p>シンボリックリンクも同期したい場合は、以下のような設定をプロファイルに追記します。</p>

<pre><code>follow = Path ディレクトリ名 または ファイル名
</code></pre>

<h2 id="除外ファイル">除外ファイル</h2>

<p>OSごとに特有のファイルがありますし、同期をしたくないファイルは除外ファイルとして登録しておきます。<code>ignore_filelist_macos</code>にしておきます。設定などのファイル保存先は<code>.unison</code>フォルダーです。</p>

<pre><code>jin@gallo:.unison $ vi ~/.unison/ignore_filelist_macos

addprefsto = unison_ignore

# for macOS
ignore = Name ._*
ignore = Name .DS_Store
ignore = Name .Trash
ignore = Name .Spotlight-*
ignore = Name .Trashes
ignore = Name .hidden
ignore = Name .hotfiles.btree
ignore = Name .vol

ignore = Name .FBCIndex
ignore = Name .FBCLockFolder

ignore = Name .CFUserTextEncoding
ignore = Name .localized
</code></pre>

<h2 id="実行">実行</h2>

<p><code>unison 設定ファイル名</code>で同期します。初回は少し時間がかかるといいますが、ファイル数が少ないので瞬間で終わりました。
同期するファイルの確認を行います、問題がなければ、そのまま<code>y</code>で続行します。
同じ名前のファイルがあったら、選択する必要があります（たしか）。</p>

<div class="hint">※ 沢山のファイル（例えば1000とか）がある人は、まずは rsync でファイルをコピーしてから行った方が良いかな。</div>

<pre><code>jin@gallo:~ $ unison tacos_scripts
Unison 2.51.2 (ocaml 4.06.1): Contacting server...
Connected [//gallo.goozen.lab//Volumes/Work/Development/Scripts -&gt; //tacos//home/pi/scripts]
Looking for changes
Warning: No archive files were found for these roots, whose canonical names are:
	/Volumes/Work/Development/Scripts
	//tacos//home/pi/scripts

　。。。。。

  Waiting for changes from server
Reconciling changes

local          tacos
dir      ----&gt;            Date Clip.app
dir      ----&gt;            MakeIcons.app
dir      ----&gt;            ResizeRenameImage.app
         &lt;---- file       task_on_reboot.sh
         &lt;---- file       weather_update.py

Proceed with propagating updates? [] y

　。。。。。

[END] Copying resize window.app
UNISON 2.51.2 (OCAML 4.06.1) finished propagating changes at 07:59:09.42 on 18 Aug 2019

Saving synchronizer state
Synchronization complete at 07:59:09  (23 items transferred, 0 skipped, 0 failed)
jin@gallo:~ $
</code></pre>

<p>これで、</p>

<p>スクリプトを端末側で修正・コマンドで同期・サーバー側で実行・確認の繰り返し。</p>

<p>という流作業になる。ちょっとだけ面倒が取れるかな。</p>

<p>※ マック側のファイルのスペースは取った方が良いかもしれん。。キャメルからスネーク式に切り替えるかな。。</p>

<h2 id="おまけ-自動化">おまけ：自動化</h2>

<p><strong>cron</strong> で定期的にunisonによる同期を実行したい場合は<code>-batch</code>
オプションを付けて実行すると非対話的に同期が実行されます。</p>

<pre><code>jin@gallo:~ $ unison tacos_scripts -batch
</code></pre>

<p><code>crontab -e</code>に登録して自動化完了です。</p>

<h3 id="マックにての自動化">マックにての自動化</h3>

<p>マックでは<code>LaunchAgents</code>を使って自動化ができます。
設定ファイル<code>~/Library/LaunchAgents/mac-pi-unison.plist</code>を作成します。</p>

<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;
&lt;plist version=&quot;1.0&quot;&gt;
&lt;dict&gt;
  &lt;!-- label --&gt;
  &lt;key&gt;Label&lt;/key&gt;
  &lt;string&gt;mac-pi-unison&lt;/string&gt;

  &lt;!-- script --&gt;
  &lt;key&gt;ProgramArguments&lt;/key&gt;
  &lt;array&gt;
    &lt;string&gt;/usr/local/bin/unison&lt;/string&gt;
    &lt;!-- ここに引数となる設定名を指定します(.prfを除外した名前) --&gt;
    &lt;string&gt;sample&lt;/string&gt;
    &lt;!-- Yes/Noを聞かれないバッチ用のオプション --&gt;
    &lt;string&gt;-batch&lt;/string&gt;
  &lt;/array&gt;

  &lt;!-- launchctl loadしたタイミングで実行するか --&gt;
  &lt;key&gt;RunAtLoad&lt;/key&gt;
  &lt;true/&gt;

  &lt;!-- インターバル指定 例) 5分毎 --&gt;
  &lt;key&gt;StartInterval&lt;/key&gt;
  &lt;integer&gt;300&lt;/integer&gt;

  &lt;!-- エラー内容を捨ててますが、ちゃんと運用したい場合はこの設定もしっかり --&gt;
  &lt;key&gt;StandardErrorPath&lt;/key&gt;
  &lt;string&gt;/dev/null&lt;/string&gt;
  &lt;key&gt;StandardOutPath&lt;/key&gt;
  &lt;string&gt;/dev/null&lt;/string&gt;
&lt;/dict&gt;

&lt;/plist&gt;
</code></pre>

<p>そして、LaunchAgentsの読み込みます。</p>

<pre><code>jin@gallo:~ $ launchctl load ~/Library/LaunchAgents/mac-pi-unison.plist
</code></pre>

<p>これで、バックグラウンドで5分ごとに動いてくれるようになります。
ただ、私は<code>hazel</code>というアプリを持っているので、それでファイル更新にトリガーで動かしても良いなと思いました。</p>

<p>参考：</p>

<ul>
<li><a href="http://uzy-exe.hateblo.jp/entry/2013/12/29/071159">unisonによる2台のサーバ間でのファイル同期</a></li>
<li><a href="https://88171.net/unison_manual_ja">Unisonマニュアル私的日本語訳 - 88171.net</a></li>
</ul>

<!--
## おまけ

バックグラウンで静かに走っているのは良いのですが、ちょっと寂しいので同期をしたときに、通知するアップルスクリプトを追加しました。

$1にさっきの設定ファイル(.prf)を拡張子なしで渡してやる．

~/Documents/exec/nortificate.sh

```
#!/bin/bash

unison "$1"

echo 'display notification "Unison Notifier" with title "Unison" subtitle "ファイルを同期しました。"' | osascript
```
-->

				

<h3>See Also</h3>
<ul>
	
	<li><a href="/blog/2019/08/build-unison/">Unisonをビルドする</a></li>
	
	<li><a href="/blog/2019/07/syncthing-settings/">Syncthingの詳細設定</a></li>
	
	<li><a href="/blog/2019/06/syncthing-install/">Syncthingのインストールと設定</a></li>
	
</ul>


            </div>
       		
			<div class="post-content">
       	 		<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "goozenlabgh" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
       		</div>
            
        </div>
	</div>
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
</div>


<div class="footer pure-g">
    <div class="pure-u-1-24 pure-u-md-3-24"></div>
    <div class="pure-u-11-12 pure-u-md-20-24">
		<div style="margin-top:-26px; margin-left:-13px;"><img src="/images/site/footer-owl.png" alt="Owl" /></div>
        <div class="footer-content">
 		  <div class="pure-menu pure-menu-horizontal">
              <ul>







			      
                  <li class="pure-menu-heading" id="foot-name">Jin K.:</li>
                  

                  
                  <li class="pure-menu-item">
                      <a href="mailto:jin@goozenlab.com" class="pure-menu-link">Email</a>
                  </li>
                  

                  

                  

                  

                  
                  <li class="pure-menu-item">
                      <a href="https://twitter.com/goozenlab" class="pure-menu-link">Twitter</a>
                  </li>
                  
              </ul>
              <a href="#" class="pure-menu-heading pull-right" id="gototop-btn">↑↑</a>
          </div>
		  
		  <p id="foot-copyright">Copyright 2019, goozenlab; all rights reserved.</p>
		  
		</div>
      <div class="pure-u-1-24 pure-u-md-1-24"></div>
</div>


<script src="https://goozenlab.com/js/jquery.min.js" type="text/javascript"></script>
<script src="https://goozenlab.com/js/jquery.timeago.js" type="text/javascript"></script>
<script type="text/javascript">
  $(function(){
    $("time.timeago").timeago();
  })
  $("#toggle-btn").click(function(){
    $("#toggle-content").toggle();
    if($(this).html() === "☰") {
        $(this).html("X")
    } else {
        $(this).html("☰")
    }
  });
  $(window).resize(function(){
    if(window.innerWidth > 768) {
      $(".desktop").removeAttr("style");
    }
  });
</script>



</body>
</html>



